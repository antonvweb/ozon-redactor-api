name: Deploy Prod

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.set-modules.outputs.modules || '[]' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed modules
        id: detect
        uses: tj-actions/changed-files@v45
        with:
          base: origin/main
          fetch_depth: 0
          json: true

      - name: Extract modules
        id: set-modules
        run: |
          raw='${{ steps.detect.outputs.all_changed_files_json }}'
          [ -z "$raw" ] && raw='${{ steps.detect.outputs.all_changed_files }}'
          clean_json=$(echo "$raw" | sed 's/\\"/"/g')
          echo "$clean_json" > temp.json
          modules=$(jq -c '[.[] | select(test("^(common|domain|authService|ozonApi|userService|notification)/")) | split("/")[0]] | unique' temp.json)
          modules=$(echo "$modules" | jq -c 'if index("common") == null then . + ["common"] else . end | if index("domain") == null then . + ["domain"] else . end')
          echo "modules=$modules" >> $GITHUB_OUTPUT

  deploy-project-root:
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          private-key: ${{ secrets.SERVER_SSH_KEY }}
          known-hosts: unnecessary
          config: |
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR

      - name: Sync entire project to server
        run: |
          echo "Синхронизируем весь проект..."
          rsync -avz --delete \
            --exclude='.git' --exclude='target' --exclude='.idea' --exclude='*.log' --exclude='node_modules' \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/
          echo "Синхронизация завершена. Проверяем наличие pom.xml на сервере..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "ls ${{ secrets.DEPLOY_PROD_PATH }}/pom.xml || echo 'pom.xml не найден!'"

  deploy-common:
    needs: [detect-changes, deploy-project-root]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'common') || contains(fromJson(needs.detect-changes.outputs.modules), 'domain')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          private-key: ${{ secrets.SERVER_SSH_KEY }}
          known-hosts: unnecessary
          config: |
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR

      - name: Install common & domain
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            if [ ! -f pom.xml ]; then
              echo "Ошибка: корневой pom.xml не найден!"
              exit 1
            fi
            mvn -U clean install -pl common,domain -am -DskipTests
          EOF

  deploy-authService:
    needs: [detect-changes, deploy-project-root, deploy-common]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'authService')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          private-key: ${{ secrets.SERVER_SSH_KEY }}
          known-hosts: unnecessary
          config: |
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR

      - name: Sync & Build & Restart authService
        run: |
          echo "Синхронизация authService..."
          rsync -avz --delete --exclude .idea --exclude target ./authService/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/authService/

          echo "Сборка authService..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/authService
            if [ ! -f pom.xml ]; then
              echo "Ошибка: pom.xml в authService не найден!"
              exit 1
            fi
            mvn clean package -DskipTests
          EOF

          echo "Перезапуск auth-service..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -ex
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            if [ ! -f ecosystem.backend.config.js ]; then
              echo "Ошибка: ecosystem.backend.config.js не найден!"
              exit 1
            fi
            sudo pm2 delete auth-service || true
            sudo pm2 start ecosystem.backend.config.js --only auth-service --update-env
            sudo pm2 save
          EOF

  deploy-ozonApi:
    needs: [detect-changes, deploy-project-root, deploy-common]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'ozonApi')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          private-key: ${{ secrets.SERVER_SSH_KEY }}
          known-hosts: unnecessary
          config: |
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR

      - name: Sync & Build & Restart ozonApi
        run: |
          echo "Синхронизация ozonApi..."
          rsync -avz --delete --exclude .idea --exclude target ./ozonApi/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/ozonApi/

          echo "Сборка ozonApi..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/ozonApi
            if [ ! -f pom.xml ]; then
              echo "Ошибка: pom.xml в ozonApi не найден!"
              exit 1
            fi
            mvn clean package -DskipTests
          EOF

          echo "Перезапуск ozon-api..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -ex
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            if [ ! -f ecosystem.backend.config.js ]; then
              echo "Ошибка: ecosystem.backend.config.js не найден!"
              exit 1
            fi
            sudo pm2 delete ozon-api || true
            sudo pm2 start ecosystem.backend.config.js --only ozon-api --update-env
            sudo pm2 save
          EOF

  deploy-userService:
    needs: [detect-changes, deploy-project-root, deploy-common]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'userService')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          private-key: ${{ secrets.SERVER_SSH_KEY }}
          known-hosts: unnecessary
          config: |
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR

      - name: Sync & Build & Restart userService
        run: |
          echo "Синхронизация userService..."
          rsync -avz --delete --exclude .idea --exclude target ./userService/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/userService/

          echo "Сборка userService..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/userService
            if [ ! -f pom.xml ]; then
              echo "Ошибка: pom.xml в userService не найден!"
              exit 1
            fi
            mvn clean package -DskipTests
          EOF

          echo "Перезапуск user-service..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -ex
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            if [ ! -f ecosystem.backend.config.js ]; then
              echo "Ошибка: ecosystem.backend.config.js не найден!"
              exit 1
            fi
            sudo pm2 delete user-service || true
            sudo pm2 start ecosystem.backend.config.js --only user-service --update-env
            sudo pm2 save
          EOF

  deploy-notification:
    needs: [detect-changes, deploy-project-root, deploy-common]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'notification')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          private-key: ${{ secrets.SERVER_SSH_KEY }}
          known-hosts: unnecessary
          config: |
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR

      - name: Sync & Build & Restart notification
        run: |
          echo "Синхронизация notification..."
          rsync -avz --delete --exclude .idea --exclude target ./notification/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/notification/

          echo "Сборка notification..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/notification
            if [ ! -f pom.xml ]; then
              echo "Ошибка: pom.xml в notification не найден!"
              exit 1
            fi
            mvn clean package -DskipTests
          EOF

          echo "Перезапуск notification-service..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -ex
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            if [ ! -f ecosystem.backend.config.js ]; then
              echo "Ошибка: ecosystem.backend.config.js не найден!"
              exit 1
            fi
            sudo pm2 delete notification-service || true
            sudo pm2 start ecosystem.backend.config.js --only notification-service --update-env
            sudo pm2 save
          EOF