name: Deploy Prod

on:
  push:
    branches:
      - main

env:
  DEPLOY_PATH: ${{ secrets.DEPLOY_PROD_PATH }}

jobs:
  # 1. Определяем какие модули изменились И какие нужно пересобрать
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      common: ${{ steps.changes.outputs.common }}
      authService: ${{ steps.changes.outputs.authService }}
      userService: ${{ steps.changes.outputs.userService }}
      ozonApi: ${{ steps.changes.outputs.ozonApi }}
      # Флаги что нужно БИЛДИТЬ (с учётом зависимостей)
      build-common: ${{ steps.changes.outputs.common }}
      build-authService: ${{ steps.build.outputs.authService }}
      build-userService: ${{ steps.build.outputs.userService }}
      build-ozonApi: ${{ steps.build.outputs.ozonApi }}
      any-changes: ${{ steps.changes.outputs.any }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        id: changes
        run: |
          # Получаем список изменённых файлов
          CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || git diff --name-only HEAD~1 HEAD)

          echo "Changed files:"
          echo "$CHANGED"

          # Проверяем каждый модуль
          if echo "$CHANGED" | grep -q "^common/"; then
            echo "common=true" >> $GITHUB_OUTPUT
          else
            echo "common=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED" | grep -q "^authService/"; then
            echo "authService=true" >> $GITHUB_OUTPUT
          else
            echo "authService=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED" | grep -q "^userService/"; then
            echo "userService=true" >> $GITHUB_OUTPUT
          else
            echo "userService=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED" | grep -q "^ozonApi/"; then
            echo "ozonApi=true" >> $GITHUB_OUTPUT
          else
            echo "ozonApi=false" >> $GITHUB_OUTPUT
          fi

          # Проверяем есть ли вообще изменения в модулях
          if echo "$CHANGED" | grep -qE "^(common|authService|userService|ozonApi)/"; then
            echo "any=true" >> $GITHUB_OUTPUT
          else
            echo "any=false" >> $GITHUB_OUTPUT
          fi

      - name: Calculate build targets (with dependencies)
        id: build
        run: |
          # Граф зависимостей:
          # common <- authService, userService, ozonApi
          # userService <- ozonApi

          COMMON="${{ steps.changes.outputs.common }}"
          AUTH="${{ steps.changes.outputs.authService }}"
          USER="${{ steps.changes.outputs.userService }}"
          OZON="${{ steps.changes.outputs.ozonApi }}"

          # authService: билдим если изменился он ИЛИ common
          if [[ "$AUTH" == "true" || "$COMMON" == "true" ]]; then
            echo "authService=true" >> $GITHUB_OUTPUT
          else
            echo "authService=false" >> $GITHUB_OUTPUT
          fi

          # userService: билдим если изменился он ИЛИ common
          if [[ "$USER" == "true" || "$COMMON" == "true" ]]; then
            echo "userService=true" >> $GITHUB_OUTPUT
          else
            echo "userService=false" >> $GITHUB_OUTPUT
          fi

          # ozonApi: билдим если изменился он ИЛИ common ИЛИ userService
          if [[ "$OZON" == "true" || "$COMMON" == "true" || "$USER" == "true" ]]; then
            echo "ozonApi=true" >> $GITHUB_OUTPUT
          else
            echo "ozonApi=false" >> $GITHUB_OUTPUT
          fi

  # 2. Синхронизация проекта на сервер (один раз)
  sync-project:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any-changes == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SERVER_SSH_KEY }}
          known_hosts: unnecessary
          config: |
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR

      - name: Create .env file on server
        run: |
          cat << 'EOF' | sed 's/^[[:space:]]*//' | ssh -p ${{ secrets.SERVER_SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "cat > ${{ env.DEPLOY_PATH }}/.env && chmod 600 ${{ env.DEPLOY_PATH }}/.env"
          DB_URL=${{ secrets.DB_URL }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          COOKIE_SECURE=true
          COOKIE_DOMAIN=.print-365.ru
          LOG_LEVEL=WARN
          SHOW_SQL=false
          EOF

      - name: Sync project to server
        run: |
          rsync -avz --delete \
            --timeout=120 \
            --partial \
            -e "ssh -p ${{ secrets.SERVER_SSH_PORT }} -o ConnectTimeout=30 -o ServerAliveInterval=15 -o ServerAliveCountMax=3" \
            --exclude='.git' \
            --exclude='target' \
            --exclude='.idea' \
            --exclude='*.log' \
            --exclude='node_modules' \
            --exclude='.env' \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/

  # 3. Билд common (если изменился)
  build-common:
    runs-on: ubuntu-latest
    needs: [detect-changes, sync-project]
    if: needs.detect-changes.outputs.build-common == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SERVER_SSH_KEY }}
          known_hosts: unnecessary
          config: StrictHostKeyChecking no

      - name: Build and install common
        run: |
          ssh -p ${{ secrets.SERVER_SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ env.DEPLOY_PATH }}
            echo "=== Building common module ==="
            mvn -U clean install -pl common -DskipTests
            echo "=== common installed to local repository ==="
          EOF

  # 4. Билд authService
  build-authService:
    runs-on: ubuntu-latest
    needs: [detect-changes, sync-project, build-common]
    # Запускаем если нужно билдить И (common уже собран ИЛИ common не менялся)
    if: |
      always() &&
      needs.detect-changes.outputs.build-authService == 'true' &&
      needs.sync-project.result == 'success' &&
      (needs.build-common.result == 'success' || needs.build-common.result == 'skipped')
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SERVER_SSH_KEY }}
          known_hosts: unnecessary
          config: StrictHostKeyChecking no

      - name: Build and deploy authService
        run: |
          ssh -p ${{ secrets.SERVER_SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ env.DEPLOY_PATH }}
            echo "=== Building authService ==="
            mvn clean package -pl authService -am -DskipTests

            echo "=== Restarting auth-service ==="
            set -a && source .env && set +a
            pm2 delete auth-service || true
            pm2 start ecosystem.backend.config.js --only auth-service --update-env
            pm2 save
          EOF

  # 5. Билд userService
  build-userService:
    runs-on: ubuntu-latest
    needs: [detect-changes, sync-project, build-common]
    if: |
      always() &&
      needs.detect-changes.outputs.build-userService == 'true' &&
      needs.sync-project.result == 'success' &&
      (needs.build-common.result == 'success' || needs.build-common.result == 'skipped')
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SERVER_SSH_KEY }}
          known_hosts: unnecessary
          config: StrictHostKeyChecking no

      - name: Build and deploy userService
        run: |
          ssh -p ${{ secrets.SERVER_SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ env.DEPLOY_PATH }}
            echo "=== Building userService ==="
            mvn clean install -pl userService -am -DskipTests

            echo "=== Restarting user-service ==="
            set -a && source .env && set +a
            pm2 delete user-service || true
            pm2 start ecosystem.backend.config.js --only user-service --update-env
            pm2 save
          EOF

  # 6. Билд ozonApi (зависит от userService)
  build-ozonApi:
    runs-on: ubuntu-latest
    needs: [detect-changes, sync-project, build-common, build-userService]
    if: |
      always() &&
      needs.detect-changes.outputs.build-ozonApi == 'true' &&
      needs.sync-project.result == 'success' &&
      (needs.build-common.result == 'success' || needs.build-common.result == 'skipped') &&
      (needs.build-userService.result == 'success' || needs.build-userService.result == 'skipped')
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SERVER_SSH_KEY }}
          known_hosts: unnecessary
          config: StrictHostKeyChecking no

      - name: Build and deploy ozonApi
        run: |
          ssh -p ${{ secrets.SERVER_SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ env.DEPLOY_PATH }}
            echo "=== Building ozonApi ==="
            mvn clean package -pl ozonApi -am -DskipTests

            echo "=== Restarting ozon-api ==="
            set -a && source .env && set +a
            pm2 delete ozon-api || true
            pm2 start ecosystem.backend.config.js --only ozon-api --update-env
            pm2 save
          EOF

  # 7. Summary
  summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-common, build-authService, build-userService, build-ozonApi]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "## Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Module | Changed | Built | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| common | ${{ needs.detect-changes.outputs.common }} | ${{ needs.detect-changes.outputs.build-common }} | ${{ needs.build-common.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| authService | ${{ needs.detect-changes.outputs.authService }} | ${{ needs.detect-changes.outputs.build-authService }} | ${{ needs.build-authService.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| userService | ${{ needs.detect-changes.outputs.userService }} | ${{ needs.detect-changes.outputs.build-userService }} | ${{ needs.build-userService.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ozonApi | ${{ needs.detect-changes.outputs.ozonApi }} | ${{ needs.detect-changes.outputs.build-ozonApi }} | ${{ needs.build-ozonApi.result }} |" >> $GITHUB_STEP_SUMMARY
