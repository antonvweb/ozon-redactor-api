name: Deploy Prod

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.set-modules.outputs.modules || '[]' }}

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Detect changed modules
        id: detect
        uses: tj-actions/changed-files@v45
        with:
          base: origin/main
          fetch_depth: 0
          json: true

      - name: ðŸ“‹ Extract modules
        id: set-modules
        run: |
          raw='${{ steps.detect.outputs.all_changed_files_json }}'

          if [ -z "$raw" ]; then
            echo "âš ï¸ all_changed_files_json Ð¿ÑƒÑÑ‚Ð¾Ð¹, fallback Ð½Ð° all_changed_files"
            raw='${{ steps.detect.outputs.all_changed_files }}'
          fi

          clean_json=$(echo "$raw" | sed 's/\\"/"/g')
          echo "ðŸ” ÐžÑ‡Ð¸Ñ‰ÐµÐ½Ð½Ñ‹Ð¹ JSON: $clean_json"
          echo "$clean_json" > temp.json

          modules=$(jq -c '[.[] 
            | select(test("^(common|domain|authService|ozonApi|userService|notification)/")) 
            | split("/")[0]] | unique' temp.json)

          modules=$(echo "$modules" | jq -c 'if index("common") == null then . + ["common"] else . end | if index("domain") == null then . + ["domain"] else . end')

          echo "modules=$modules" >> $GITHUB_OUTPUT
          echo "ðŸ” Ð’Ñ‹Ñ…Ð¾Ð´Ð½Ð¾Ð¹ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ modules: $modules"

      - name: ðŸ” Debug all changes
        run: |
          echo "all_changed_files_json=${{ steps.detect.outputs.all_changed_files_json }}"
          echo "all_changed_files=${{ steps.detect.outputs.all_changed_files }}"

  deploy-common:
    needs: detect-changes
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'common') || contains(fromJson(needs.detect-changes.outputs.modules), 'domain')
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: ðŸ§± Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ”Œ Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo âœ… SSH connected"

      - name: Sync root pom.xml to server
        run: |
          rsync -avz pom.xml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/

      - name: Sync common & domain to server
        run: |
          rsync -avz --delete --exclude .idea --exclude target ./common/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/common/
          rsync -avz --delete --exclude .idea --exclude target ./domain/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/domain/

      - name: Install common & domain on server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/common
            mvn clean install
            cd ${{ secrets.DEPLOY_PROD_PATH }}/domain
            mvn clean install
          EOF

  deploy-authService:
    needs: [detect-changes, deploy-common]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'authService')
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: ðŸ§± Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ”Œ Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo âœ… SSH connected"

      - name: Sync authService to server
        run: |
          rsync -avz --delete --exclude .idea --exclude target ./authService/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/authService/

      - name: Build authService on server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/authService
            mvn clean -U
            mvn package
          EOF

      - name: Restart authService
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -ex
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            sudo pm2 delete auth-service || true
            sudo pm2 start ecosystem.backend.config.js --only auth-service
            sudo pm2 save
          EOF

  deploy-ozonApi:
    needs: [detect-changes, deploy-common]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'ozonApi')
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: ðŸ§± Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ”Œ Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo âœ… SSH connected"

      - name: Sync ozonApi to server
        run: |
          rsync -avz --delete --exclude .idea --exclude target ./ozonApi/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/ozonApi/

      - name: Build ozonApi on server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/ozonApi
            mvn clean -U
            mvn package
          EOF

      - name: Restart ozonApi
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -ex
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            sudo pm2 delete ozon-api || true
            sudo pm2 start ecosystem.backend.config.js --only ozon-api
            sudo pm2 save
          EOF

  deploy-userService:
    needs: [detect-changes, deploy-common]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'userService')
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: ðŸ§± Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ”Œ Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo âœ… SSH connected"

      - name: Sync userService to server
        run: |
          rsync -avz --delete --exclude .idea --exclude target ./userService/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/userService/

      - name: Build userService on server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/userService
            mvn clean -U
            mvn package
          EOF

      - name: Restart userService
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -ex
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            sudo pm2 delete user-service || true
            sudo pm2 start ecosystem.backend.config.js --only user-service
            sudo pm2 save
          EOF

  deploy-notification:
    needs: [detect-changes, deploy-common]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'notification')
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: ðŸ§± Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ”Œ Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo âœ… SSH connected"

      - name: Sync notification to server
        run: |
          rsync -avz --delete --exclude .idea --exclude target ./notification/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/notification/

      - name: Build notification on server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/notification
            mvn clean -U
            mvn package
          EOF

      - name: Restart notification
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -ex
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            sudo pm2 delete notification-service || true
            sudo pm2 start ecosystem.backend.config.js --only notification-service
            sudo pm2 save
          EOF