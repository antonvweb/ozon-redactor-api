name: Deploy Prod

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.set-modules.outputs.modules || '[]' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed modules
        id: detect
        uses: tj-actions/changed-files@v45
        with:
          base: origin/main
          fetch_depth: 0
          json: true

      - name: Extract modules
        id: set-modules
        run: |
          raw='${{ steps.detect.outputs.all_changed_files_json }}'
          [ -z "$raw" ] && raw='${{ steps.detect.outputs.all_changed_files }}'
          clean_json=$(echo "$raw" | sed 's/\\"/"/g')
          echo "$clean_json" > temp.json
          modules=$(jq -c '[.[] | select(test("^(common|domain|authService|ozonApi|userService|notification)/")) | split("/")[0]] | unique' temp.json)
          modules=$(echo "$modules" | jq -c 'if index("common") == null then . + ["common"] else . end | if index("domain") == null then . + ["domain"] else . end')
          echo "modules=$modules" >> $GITHUB_OUTPUT

  # 1. Синхронизация всего проекта (включая корневой pom.xml)
  deploy-project-root:
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH (100% работает)
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SERVER_SSH_KEY }}
          known_hosts: unnecessary
          config: |
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR

      - name: Sync entire project
        run: |
          echo "Синхронизация всего проекта в ${{ secrets.DEPLOY_PROD_PATH }}..."
          rsync -avz --delete \
            --exclude='.git' --exclude='target' --exclude='.idea' --exclude='*.log' --exclude='node_modules' \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/

  # 2. Установка common + domain (всегда, если они изменились)
  deploy-common:
    needs: [detect-changes, deploy-project-root]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'common')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SERVER_SSH_KEY }}
          known_hosts: unnecessary
          config: StrictHostKeyChecking no
      - name: Install common & domain
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            echo "Установка common и domain..."
            mvn -U clean install -pl common,domain -am -DskipTests
            echo "common и domain установлены в локальный репозиторий"
          EOF

  # 3. userService — теперь видит notification
  deploy-userService:
    needs: [detect-changes, deploy-project-root, deploy-common]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'userService')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SERVER_SSH_KEY }}
          known_hosts: unnecessary
          config: StrictHostKeyChecking no
      - name: Deploy userService
        run: |
          rsync -avz --delete --exclude .idea --exclude target ./userService/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/userService/

          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/userService
            echo "Сборка userService (notification уже в ~/.m2)"
            mvn clean package -DskipTests
          EOF

          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -ex
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            sudo pm2 delete user-service || true
            sudo pm2 start ecosystem.backend.config.js --only user-service --update-env
            sudo pm2 save
          EOF

  # 5. Остальные сервисы (не зависят от notification)
  deploy-authService:
    needs: [detect-changes, deploy-project-root, deploy-common]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'authService')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SERVER_SSH_KEY }}
          known_hosts: unnecessary
          config: StrictHostKeyChecking no
      - name: Deploy authService
        run: |
          rsync -avz --delete --exclude .idea --exclude target ./authService/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/authService/
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/authService
            mvn clean package -DskipTests
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            sudo pm2 delete auth-service || true
            sudo pm2 start ecosystem.backend.config.js --only auth-service --update-env
            sudo pm2 save
          EOF

  deploy-ozonApi:
    needs: [detect-changes, deploy-project-root, deploy-common]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'ozonApi')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SERVER_SSH_KEY }}
          known_hosts: unnecessary
          config: StrictHostKeyChecking no
      - name: Deploy ozonApi
        run: |
          rsync -avz --delete --exclude .idea --exclude target ./ozonApi/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/ozonApi/
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/ozonApi
            mvn clean package -DskipTests
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            sudo pm2 delete ozon-api || true
            sudo pm2 start ecosystem.backend.config.js --only ozon-api --update-env
            sudo pm2 save
          EOF