name: Deploy Prod

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.set-modules.outputs.modules || '[]' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed modules
        id: detect
        uses: tj-actions/changed-files@v45
        with:
          base: origin/main
          fetch_depth: 0
          json: true

      - name: Extract modules
        id: set-modules
        run: |
          raw='${{ steps.detect.outputs.all_changed_files_json }}'
          [ -z "$raw" ] && raw='${{ steps.detect.outputs.all_changed_files }}'
          clean_json=$(echo "$raw" | sed 's/\\"/"/g')
          echo "$clean_json" > temp.json
          modules=$(jq -c '[.[] | select(test("^(common|domain|authService|ozonApi|userService|notification)/")) | split("/")[0]] | unique' temp.json)
          modules=$(echo "$modules" | jq -c 'if index("common") == null then . + ["common"] else . end | if index("domain") == null then . + ["domain"] else . end')
          echo "modules=$modules" >> $GITHUB_OUTPUT

  # Один раз синхронизируем весь проект + настраиваем SSH правильно
  deploy-project-root:
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Add server to known_hosts (один раз!)
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'SSH OK'"

      - name: Sync entire project to server
        run: |
          echo "Синхронизируем весь проект..."
          rsync -avz --delete \
            --exclude='.git' --exclude='target' --exclude='.idea' --exclude='*.log' --exclude='node_modules' \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/

  deploy-common:
    needs: [detect-changes, deploy-project-root]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'common') || contains(fromJson(needs.detect-changes.outputs.modules), 'domain')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Install common & domain
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            mvn -U clean install -pl common,domain -am -DskipTests
          EOF

  # Все остальные сервисы — без ssh-keyscan и known_hosts!
  deploy-authService:
    needs: [detect-changes, deploy-project-root, deploy-common]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'authService')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Sync & Build & Restart authService
        run: |
          rsync -avz --delete --exclude .idea --exclude target ./authService/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/authService/

          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/authService
            mvn clean package -DskipTests

            cd ${{ secrets.DEPLOY_PROD_PATH }}
            sudo pm2 delete auth-service || true
            sudo pm2 start ecosystem.backend.config.js --only auth-service
            sudo pm2 save
          EOF

  deploy-ozonApi:
    needs: [ detect-changes, deploy-common, deploy-project-root ]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'ozonApi')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Sync & Build & Restart ozonApi
        run: |
          echo "Синхронизация ozonApi..."
          rsync -avz --delete --exclude .idea --exclude target ./ozonApi/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/ozonApi/

          echo "Сборка ozonApi на сервере..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/ozonApi
            mvn clean package -DskipTests
          EOF

          echo "Перезапуск ozon-api через PM2..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -ex
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            sudo pm2 delete ozon-api || true
            sudo pm2 start ecosystem.backend.config.js --only ozon-api --update-env
            sudo pm2 save
          EOF

  deploy-userService:
    needs: [ detect-changes, deploy-common, deploy-project-root ]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'userService')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Sync & Build & Restart userService
        run: |
          echo "Синхронизация userService..."
          rsync -avz --delete --exclude .idea --exclude target ./userService/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/userService/

          echo "Сборка userService на сервере..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/userService
            mvn clean package -DskipTests
          EOF

          echo "Перезапуск user-service через PM2..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -ex
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            sudo pm2 delete user-service || true
            sudo pm2 start ecosystem.backend.config.js --only user-service --update-env
            sudo pm2 save
          EOF

  deploy-notification:
    needs: [ detect-changes, deploy-common, deploy-project-root ]
    if: contains(fromJson(needs.detect-changes.outputs.modules), 'notification')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Sync & Build & Restart notification
        run: |
          echo "Синхронизация notification..."
          rsync -avz --delete --exclude .idea --exclude target ./notification/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PROD_PATH }}/notification/

          echo "Сборка notification на сервере..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PROD_PATH }}/notification
            mvn clean package -DskipTests
          EOF

          echo "Перезапуск notification-service через PM2..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -ex
            cd ${{ secrets.DEPLOY_PROD_PATH }}
            sudo pm2 delete notification-service || true
            sudo pm2 start ecosystem.backend.config.js --only notification-service --update-env
            sudo pm2 save
          EOF